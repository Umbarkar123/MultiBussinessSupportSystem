{% extends "layout.html" %}
{% block content %}

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

{# Pre-process numeric data to avoid script formatting issues #}
{% set js_total = total | default(0) %}
{% set js_confirmed = confirmed | default(0) %}
{% set js_pending = pending | default(0) %}
{% set js_cancelled = cancelled | default(0) %}

<div class="ana-wrap">

    <!-- HEADER -->
    <div class="ana-header">
        <div>
            <h1>Client Form Management Portal</h1>
            <p>Manage, review and approve user form submissions</p>
        </div>
        <button class="ana-export" onclick="exportTable()">Export CSV</button>
    </div>

    <!-- KPI ROW (4 Compact Cards) -->
    <div class="ana-kpi-row">
        <div class="ana-kpi">
            <span>Total Forms</span>
            <h2 style="color: var(--primary);">{{ total }}</h2>
        </div>
        <div class="ana-kpi">
            <span>Approved</span>
            <h2 style="color: var(--success);">{{ confirmed }}</h2>
        </div>
        <div class="ana-kpi">
            <span>Pending</span>
            <h2 style="color: #f59e0b;">{{ pending }}</h2>
        </div>
        <div class="ana-kpi">
            <span>Rejected</span>
            <h2 style="color: var(--danger);">{{ cancelled }}</h2>
        </div>
    </div>

    <!-- ANALYTICS CHART SECTION (GRID) -->
    <div class="chart-section">

        <!-- FIRST ROW: 2 COLUMN (Trend & Status) -->
        <div class="chart-row main-trend">
            <!-- 1. SUBMISSIONS TREND -->
            <div class="chart-card">
                <h3><i class="fa fa-chart-line"></i> Submissions Trend</h3>
                <div class="chart-container">
                    <canvas id="trendChart" data-labels='{{ trend_labels | tojson }}'
                        data-values='{{ trend_values | tojson }}'></canvas>
                </div>
            </div>

            <!-- 2. STATUS DISTRIBUTION -->
            <div class="chart-card">
                <h3><i class="fa fa-chart-pie"></i> Status Distribution</h3>
                <div class="chart-container">
                    <canvas id="statusChart" data-confirmed="{{ confirmed }}" data-pending="{{ pending }}"
                        data-cancelled="{{ cancelled }}"></canvas>
                </div>
            </div>
        </div>

        <!-- SECOND ROW: 2 COLUMN (App & Approval Ratio) -->
        <div class="chart-row">
            <!-- 3. APPLICATION DISTRIBUTION -->
            <div class="chart-card">
                <h3><i class="fa fa-shapes"></i> Requests by Application</h3>
                <div class="chart-container">
                    <canvas id="appChart" data-labels='{{ app_labels | tojson }}'
                        data-values='{{ app_values | tojson }}'></canvas>
                </div>
            </div>

            <!-- 4. APPROVAL VS PENDING (BAR) -->
            <div class="chart-card">
                <h3><i class="fa fa-chart-bar"></i> Approval vs Pending Over Time</h3>
                <div class="chart-container">
                    <canvas id="balanceChart" data-labels='{{ trend_labels | tojson }}'
                        data-values='{{ trend_values | tojson }}'></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- TABLE SECTION (FULL WIDTH) -->
    <div class="card">
        <div class="ana-card-head" style="margin-bottom: 20px;">
            <h3>Recent Form Requests</h3>
        </div>

        <div class="table-responsive">
            <table class="ana-table" id="dataTable">
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Phone</th>
                        <th>Call Initiated</th>
                        <th>Time</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for call in recent %}
                    <tr data-app="{{ call.app_name or 'Default' }}" data-time="{{ call.time }}"
                        data-status="{{ call.status }}">
                        <td>{{ call.name }}</td>
                        <td>{{ call.phone }}</td>
                        <td>
                            {% if call.call_initiated or call.call_initiated_at %}
                            <span style="color: var(--success); font-weight: 700;">✓ Yes</span>
                            {% else %}
                            <span style="color: var(--text-dim);">✕ No</span>
                            {% endif %}
                        </td>
                        <td>{{ call.time }}</td>
                        <td>
                            <span class="ana-status {{ call.status }}">
                                {{ call.status }}
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // Global Chart Config
    Chart.defaults.color = '#94a3b8';
    Chart.defaults.font.family = "'Inter', sans-serif";

    function initCharts() {
        // 1. Trend Chart
        const trendCtx = document.getElementById('trendChart');
        if (trendCtx) {
            new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: JSON.parse(trendCtx.dataset.labels || '[]'),
                    datasets: [{
                        label: 'Submissions',
                        data: JSON.parse(trendCtx.dataset.values || '[]'),
                        borderColor: '#00e5ff',
                        backgroundColor: 'rgba(0, 229, 255, 0.05)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointBackgroundColor: '#00e5ff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        // 2. Status Distribution
        const statusCtx = document.getElementById('statusChart');
        if (statusCtx) {
            new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Approved', 'Pending', 'Rejected'],
                    datasets: [{
                        data: [
                            parseInt(statusCtx.dataset.confirmed || 0),
                            parseInt(statusCtx.dataset.pending || 0),
                            parseInt(statusCtx.dataset.cancelled || 0)
                        ],
                        backgroundColor: [
                            'rgba(34, 197, 94, 0.7)',
                            'rgba(245, 158, 11, 0.7)',
                            'rgba(239, 68, 68, 0.7)'
                        ],
                        borderColor: 'rgba(0,0,0,0.1)',
                        borderWidth: 2,
                        hoverOffset: 12
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '75%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { padding: 10, boxWidth: 10, usePointStyle: true }
                        }
                    }
                }
            });
        }

        // 3. Application Distribution
        const appCtx = document.getElementById('appChart');
        if (appCtx) {
            const labels = JSON.parse(appCtx.dataset.labels || '[]');
            const values = JSON.parse(appCtx.dataset.values || '[]');
            new Chart(appCtx, {
                type: 'doughnut',
                data: {
                    labels: labels.length ? labels : ['General'],
                    datasets: [{
                        data: values.length ? values : [0],
                        backgroundColor: ['#00e5ff', '#a855f7', '#ec4899', '#3b82f6', '#10b981'],
                        borderColor: 'rgba(0,0,0,0.1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '65%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { padding: 10, boxWidth: 8, usePointStyle: true }
                        }
                    }
                }
            });
        }

        // 4. Approval Ratio (Balance Chart)
        const balanceCtx = document.getElementById('balanceChart');
        if (balanceCtx) {
            new Chart(balanceCtx, {
                type: 'bar',
                data: {
                    labels: JSON.parse(balanceCtx.dataset.labels || '[]'),
                    datasets: [
                        {
                            label: 'Volume',
                            data: JSON.parse(balanceCtx.dataset.values || '[]'),
                            backgroundColor: 'rgba(0, 229, 255, 0.6)',
                            borderRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' } },
                        x: { stacked: false, grid: { display: false } }
                    },
                    plugins: {
                        legend: { position: 'bottom', labels: { boxWidth: 10, padding: 10 } }
                    }
                }
            });
        }
    }

    document.addEventListener('DOMContentLoaded', initCharts);

    function exportTable() {
        let csv = [];
        document.querySelectorAll("table tr").forEach(row => {
            let cols = row.querySelectorAll("td, th");
            let data = Array.from(cols).map(c => '"' + c.innerText.replace(/"/g, '""') + '"').join(",");
            csv.push(data);
        });

        let blob = new Blob([csv.join("\n")], { type: "text/csv" });
        let a = document.createElement("a");
        let url = URL.createObjectURL(blob);
        a.href = url;
        a.download = "connexhub_form_data_" + new Date().toISOString().slice(0, 10) + ".csv";
        a.click();
        setTimeout(() => URL.revokeObjectURL(url), 100);
    }
</script>

{% endblock %}