{% extends "layout.html" %}
{% block content %}

<div class="header">
    <h1>API & Integration</h1>
    <p style="color: var(--text-dim); font-size: 13px;">Use your API key and HTML form to integrate ConnexHub into your
        website or application.</p>
</div>

{% for app in apps %}
<div class="integration-card">

    <div class="integration-top">
        <div>
            <h3>{{ app.app_name }}</h3>
            <span class="badge">Live</span>
        </div>

        <a href="#" class="action-btn" onclick="downloadHTML('{{ app.app_name }}'); return false;">
            <i class="fa fa-download" style="margin-right: 4px;"></i> Download HTML
        </a>
    </div>

    <!-- API KEY SECTION -->
    <div class="api-box">
        <label>API KEY</label>
        <div class="api-key-row">
            <input id="api_{{ app.app_name }}" value="{{ app.api_key }}" readonly>
            <button class="btn-copy" onclick="copyApi('{{ app.app_name }}')">Copy</button>
            <button class="btn-regen" onclick="regenerateKey('{{ app.app_name }}')">Regenerated</button>
            <button class="btn-revoke" onclick="revokeKey('{{ app.app_name }}')">Revoke</button>
        </div>
    </div>

    <!-- HTML FORM SECTION -->
    <div class="html-box">
        <label>Ready-to-use HTML Form</label>
        <textarea id="html_{{ app.app_name }}" readonly><form action="http://127.0.0.1:5000/api/submit/{{ app.api_key }}" method="POST">
{% for f in app.fields %}
    <label>{{ f.label }}</label>
    <input name="{{ f.name }}" placeholder="{{ f.label }}">
    <br><br>
{% endfor %}
    <button type="submit">Submit</button>
</form></textarea>
        <button class="copy-code" onclick="copyHTML('{{ app.app_name }}')">
            <i class="fa fa-copy" style="margin-right: 4px;"></i> Copy Code
        </button>
    </div>

</div>
{% endfor %}

<script>
    function copyApi(app) {
        let val = document.getElementById("api_" + app).value;
        navigator.clipboard.writeText(val);
        // Using a more subtle notification would be better, but keeping functionality for now
        showToast("API key copied to clipboard");
    }

    function copyHTML(app) {
        let val = document.getElementById("html_" + app).value;
        navigator.clipboard.writeText(val);
        showToast("HTML form code copied to clipboard");
    }

    function downloadHTML(app) {
        let text = document.getElementById("html_" + app).value;
        let blob = new Blob([text], { type: "text/html" });
        let a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = app.toLowerCase().replace(/\s+/g, '_') + "_form.html";
        a.click();
    }

    function regenerateKey(app) {
        if (confirm("Are you sure you want to regenerate this API key? The old key will stop working immediately.")) {
            fetch("/regen_key/" + app)
                .then(res => res.json())
                .then(d => {
                    location.reload();
                })
        }
    }

    function revokeKey(app) {
        if (confirm("Are you sure you want to revoke this API key? This action cannot be undone.")) {
            fetch("/revoke_key/" + app)
                .then(res => res.json())
                .then(d => {
                    location.reload();
                })
        }
    }

    function showToast(msg) {
        // Simple fallback alert if toast is not implemented, 
        // but we can assume the user wants a professional feel
        alert(msg);
    }
</script>

{% endblock %}