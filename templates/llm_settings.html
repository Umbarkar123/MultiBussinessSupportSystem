{% extends "layout.html" %}
{% block content %}

<div class="llm-wrapper" style="max-width: 1200px; margin: 0 auto; padding: 20px 40px;">

    <!-- BREADCRUMB -->
    <div class="breadcrumb"
        style="font-size: 11px; color: var(--text-dim); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.05em;">
        Applications &nbsp;/&nbsp; <span style="color: var(--primary);">AI Configuration Console</span>
    </div>

    <!-- HEADER TITLE & CONTROLS -->
    <div class="header-row"
        style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 30px; gap: 30px; flex-wrap: wrap;">
        <div style="flex: 1; min-width: 300px;">
            <h1 style="font-size: 24px; font-weight: 700; letter-spacing: -0.02em; margin: 0; color: #fff;">LLM Settings
            </h1>
            <p style="color: var(--text-dim); font-size: 13px; margin-top: 4px; line-height: 1.4;">Professional AI agent
                persona
                management and behavioral tuning.</p>
        </div>

        <!-- 1. TOP CONTROL BAR (Premium) -->
        <div class="minimal-toolbar" style="display: flex; align-items: flex-end; gap: 16px; flex-wrap: wrap;">
            <!-- App Selector -->
            <div style="display: flex; flex-direction: column; gap: 5px;">
                <label
                    style="font-size: 9px; font-weight: 800; color: var(--primary); text-transform: uppercase; letter-spacing: 0.08em; opacity: 0.8;">Application
                    Context</label>
                <select id="appSelect" onchange="selectAppFromDropdown()"
                    style="height: 38px; background: #0f172a; color: #fff; border: 1px solid rgba(0, 229, 255, 0.2); padding: 0 12px; border-radius: 6px; font-size: 13px; font-weight: 500; min-width: 180px; outline: none; transition: all 0.2s;">
                    <option value="">Select App</option>
                    {% for app in applications %}
                    <option value="{{ app['app_name'] }}">{{ app['app_name'] }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Model Selector -->
            <div style="display: flex; flex-direction: column; gap: 5px;">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <label
                        style="font-size: 9px; font-weight: 800; color: var(--primary); text-transform: uppercase; letter-spacing: 0.08em; opacity: 0.8;">Intelligence
                        Model</label>
                    <span
                        style="font-size: 8px; padding: 1px 6px; border-radius: 3px; background: rgba(0, 229, 255, 0.1); color: var(--primary); border: 1px solid rgba(0, 229, 255, 0.2); font-weight: 900;">
                        {{ profile.plan_type|upper }}
                    </span>
                </div>
                <select id="modelSelect"
                    style="height: 38px; background: #0f172a; color: #fff; border: 1px solid rgba(0, 229, 255, 0.2); padding: 0 12px; border-radius: 6px; font-size: 13px; font-weight: 600; min-width: 240px; outline: none; transition: all 0.2s;">
                    <optgroup label="Available Models">
                        {% for mid, mname in models %}
                        {% if mid in allowed_models %}
                        <option value="{{ mid }}">{{ mname }}</option>
                        {% endif %}
                        {% endfor %}
                    </optgroup>
                    <optgroup label="Locked - Upgrade Required">
                        {% for mid, mname in models %}
                        {% if mid not in allowed_models %}
                        <option value="{{ mid }}" disabled>{{ mname }} (ðŸ”’)</option>
                        {% endif %}
                        {% endfor %}
                    </optgroup>
                </select>
            </div>

            <!-- Status Toggle -->
            <div
                style="display: flex; align-items: center; gap: 10px; padding: 0 15px; height: 38px; background: rgba(255,255,255,0.02); border-radius: 6px; border: 1px solid rgba(255,255,255,0.05);">
                <div style="text-align: left;">
                    <div style="font-size: 9px; font-weight: 800; color: var(--text-dim); text-transform: uppercase;">AI
                        CORE</div>
                    <div id="statusLabel" style="font-size: 10px; color: #22c55e; font-weight: 800; line-height: 1;">
                        ACTIVE</div>
                </div>
                <label class="switch" style="width: 32px; height: 18px; margin: 0;">
                    <input type="checkbox" id="enableToggle" onchange="updateToggleUI(this)" checked>
                    <span class="slider round"></span>
                </label>
            </div>

            <button class="btn-primary neon-shadow" onclick="createApp()"
                style="height: 38px; padding: 0 16px; font-size: 11px; font-weight: 800; border-radius: 6px; display: flex; align-items: center; gap: 8px;">
                <i class="fa fa-plus"></i> NEW APP
            </button>
        </div>
    </div>

    <!-- 2. APPLICATION TABS (Pill Style) -->
    <div class="app-tabs" style="display: flex; gap: 6px; margin-bottom: 32px; overflow-x: auto; padding-bottom: 2px;">
        {% for app in client_apps %}
        <div class="tab-pill {% if loop.first %}active{% endif %}" id="tab-{{app.app_name}}"
            onclick="selectApp('{{app.app_name}}')"
            style="padding: 6px 14px; border-radius: 20px; border: 1px solid var(--border-color); cursor: pointer; font-size: 12px; font-weight: 500; white-space: nowrap; transition: all 0.2s; color: var(--text-dim); background: transparent;">
            {{ app.app_name }}
        </div>
        {% endfor %}
    </div>

    <!-- 3. MAIN CONTENT (2-COLUMN GRID) -->
    <div class="console-grid" style="display: flex; gap: 20px; align-items: stretch; margin-bottom: 20px;">

        <!-- LEFT: Base Behavior -->
        <div class="soft-card"
            style="flex: 1; background: #06121f; border: 1px solid rgba(255,255,255,0.05); border-radius: 12px; padding: 20px; display: flex; flex-direction: column;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px;">
                <h3 style="margin: 0; font-size: 16px; font-weight: 500; color: var(--text-bright);">Base System
                    Behavior</h3>
                <span
                    style="font-size: 9px; background: rgba(255,255,255,0.03); color: var(--text-dim); padding: 2px 8px; border-radius: 4px; font-weight: 700; border: 1px solid rgba(255,255,255,0.05);">CORE_LOGIC</span>
            </div>
            <p style="color: #94a3b8; font-size: 12px; margin: 0 0 16px 0; line-height: 1.4;">Foundation logic for
                booking flow and data validation. (Read Only)</p>
            <textarea id="defaultPrompt" class="compact-textarea" readonly
                style="width: 100%; flex: 1; min-height: 240px; background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.05); color: #94a3b8; font-family: 'JetBrains Mono', monospace; font-size: 12px; padding: 14px; border-radius: 8px; resize: none; outline: none;">
You are a helpful, polite booking assistant. Ask the user for necessary booking information such as date, time, number of people, name and contact details. Ask one question at a time and confirm details before ending the conversation.
            </textarea>
        </div>

        <!-- RIGHT: Agent Persona Overlay -->
        <div class="soft-card"
            style="flex: 1; background: #06121f; border: 1px solid rgba(0, 229, 255, 0.1); border-radius: 12px; padding: 20px; display: flex; flex-direction: column;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px;">
                <h3 style="margin: 0; font-size: 16px; font-weight: 500; color: var(--text-bright);">Agent Persona
                    Overlay</h3>
                <button class="reset-link" onclick="resetPrompt()"
                    style="background: none; border: none; font-size: 11px; color: var(--text-dim); cursor: pointer; transition: color 0.2s;">
                    <i class="fa fa-rotate-left"></i> Reset
                </button>
            </div>
            <p style="color: #94a3b8; font-size: 12px; margin: 0 0 16px 0; line-height: 1.4;">Custom greeting, business
                tone, and unique personality traits.</p>
            <textarea id="customPrompt" class="compact-textarea active"
                placeholder="Define exactly how the AI should represent this application..."
                style="width: 100%; flex: 1; min-height: 240px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.08); color: #e6f1ff; font-family: 'JetBrains Mono', monospace; font-size: 13px; padding: 14px; border-radius: 8px; resize: none; outline: none; transition: all 0.2s;"></textarea>

            <div style="margin-top: 16px; display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span
                        style="font-size: 10px; font-weight: 700; color: #94a3b8; text-transform: uppercase;">Creativity:</span>
                    <input type="range" min="0" max="1" step="0.1" value="0.5" id="tempSlider"
                        style="width: 80px; height: 3px; cursor: pointer;">
                    <span id="tempValue"
                        style="font-family: 'JetBrains Mono', monospace; color: var(--primary); font-size: 11px;">0.5</span>
                </div>
                <button class="btn-primary" onclick="updatePrompt()"
                    style="height: 32px; padding: 0 18px; font-size: 12px; font-weight: 600;">Save Persona</button>
            </div>
        </div>

    </div> <!-- End Grid -->

    <!-- 4. TEST SECTION (Full Width) -->
    <div class="soft-card"
        style="background: #06121f; border: 1px solid rgba(255,255,255,0.05); border-radius: 12px; padding: 20px;">
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 16px;">
            <i class="fa fa-vial" style="color: var(--primary); font-size: 14px;"></i>
            <h3 style="margin: 0; font-size: 16px; font-weight: 500; color: var(--text-bright);">Test AI Response</h3>
        </div>

        <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 16px;">
            <input type="text" placeholder="Simulate a user message..."
                style="flex: 1; height: 36px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); color: var(--text-bright); padding: 0 12px; border-radius: 6px; font-size: 13px;">
            <button class="btn-primary" onclick="runTest()"
                style="height: 36px; padding: 0 20px; font-size: 12px; font-weight: 600;">Run
                Test</button>
        </div>

        <div
            style="background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.05); border-radius: 8px; padding: 14px; min-height: 60px;">
            <label
                style="font-size: 10px; font-weight: 700; color: #94a3b8; text-transform: uppercase; display: block; margin-bottom: 6px;">Output
                Result:</label>
            <p style="margin: 0; color: #a5d6ff; font-size: 13px; line-height: 1.5; font-style: italic;">Response
                simulation will appear here based on active configuration.</p>
        </div>
    </div>

    <!-- 5. MODEL PRICING & ECONOMICS (Dynamic SaaS Panel) -->
    <div id="pricingPanel" class="model-pricing-panel"
        style="display: none; background: #06121f; border: 1px solid rgba(0, 229, 255, 0.15); border-radius: 12px; padding: 20px; margin-top: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.4);">

        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div style="display: flex; align-items: center; gap: 10px;">
                <div
                    style="width: 32px; height: 32px; background: rgba(0, 229, 255, 0.1); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                    <i class="fa fa-gem" style="color: var(--primary); font-size: 14px;"></i>
                </div>
                <div>
                    <div style="font-size: 13px; font-weight: 700; color: var(--text-bright); line-height: 1;">Unit
                        Economics</div>
                    <div style="font-size: 10px; color: var(--text-dim); margin-top: 2px;">Estimated based on token
                        averages</div>
                </div>
            </div>
            <span id="modelLevel" class="badge-model badge-premium"
                style="font-size: 9px; padding: 3px 8px; border-radius: 20px; text-transform: uppercase; font-weight: 800; letter-spacing: 0.05em;">Premium</span>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
            <div
                style="background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.05); padding: 12px; border-radius: 8px;">
                <div style="font-size: 9px; color: var(--text-dim); margin-bottom: 4px; text-transform: uppercase;">
                    Input / 1k</div>
                <div id="inputCost" style="font-size: 16px; font-weight: 600; color: var(--text-bright);">$0.005</div>
            </div>
            <div
                style="background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.05); padding: 12px; border-radius: 8px;">
                <div style="font-size: 9px; color: var(--text-dim); margin-bottom: 4px; text-transform: uppercase;">
                    Output / 1k</div>
                <div id="outputCost" style="font-size: 16px; font-weight: 600; color: var(--text-bright);">$0.015</div>
            </div>
        </div>

        <div
            style="background: rgba(0, 229, 255, 0.03); border: 1px solid rgba(0, 229, 255, 0.1); padding: 16px; border-radius: 8px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <span style="font-size: 11px; color: #94a3b8;">Avg. Cost per Call:</span>
                <span id="avgCost" style="font-size: 14px; font-weight: 700; color: var(--primary);">$0.02 / call</span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="font-size: 11px; color: #94a3b8;">Est. Monthly (on Free Plan):</span>
                <span id="monthlyEst" style="font-size: 14px; font-weight: 700; color: #fff;">$60.00</span>
            </div>
        </div>

        <div
            style="display: flex; align-items: center; gap: 8px; margin-top: 16px; padding: 10px; background: rgba(255, 255, 255, 0.02); border-radius: 6px; border-left: 3px solid var(--primary);">
            <i class="fa fa-info-circle" style="font-size: 11px; color: var(--primary);"></i>
            <p style="font-size: 10px; color: #94a3b8; margin: 0; line-height: 1.3;">These costs will be billed only if
                you exceed your monthly plan credits.</p>
        </div>
    </div>

</div>

<style>
    .tab-pill.active {
        color: var(--primary) !important;
        border-color: rgba(0, 229, 255, 0.3) !important;
        background: rgba(0, 229, 255, 0.05) !important;
    }

    .tab-pill:hover {
        border-color: rgba(255, 255, 255, 0.1);
        color: var(--text-bright);
    }

    .compact-textarea.active:focus {
        border-color: rgba(0, 229, 255, 0.4) !important;
        background: rgba(0, 229, 255, 0.02) !important;
    }

    .reset-link:hover {
        color: var(--primary) !important;
    }

    /* Toggle Switch (Sleek) */
    .switch {
        position: relative;
        display: inline-block;
        width: 32px;
        height: 16px;
    }

    .switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #1e293b;
        transition: .4s;
        border-radius: 16px;
    }

    .slider:before {
        position: absolute;
        content: "";
        height: 10px;
        width: 10px;
        left: 3px;
        bottom: 3px;
        background-color: #64748b;
        transition: .4s;
        border-radius: 50%;
    }

    input:checked+.slider {
        background-color: rgba(34, 197, 94, 0.2);
    }

    input:checked+.slider:before {
        transform: translateX(16px);
        background-color: #22c55e;
    }

    /* Range Slider */
    input[type=range] {
        -webkit-appearance: none;
        appearance: none;
        background: transparent;
    }

    input[type=range]::-webkit-slider-runnable-track {
        width: 100%;
        height: 2px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 1px;
    }

    input[type=range]::-webkit-slider-thumb {
        height: 12px;
        width: 12px;
        border-radius: 50%;
        background: var(--primary);
        cursor: pointer;
        -webkit-appearance: none;
        margin-top: -5px;
        box-shadow: 0 0 6px rgba(0, 229, 255, 0.3);
    }
</style>

<script>
    let selectedApp = "{{ client_apps[0].app_name if client_apps else '' }}";

    function selectApp(app) {
        selectedApp = app;
        document.querySelectorAll(".tab-pill").forEach(t => t.classList.remove("active"));
        const activeTab = document.getElementById("tab-" + app);
        if (activeTab) activeTab.classList.add("active");

        const dropdown = document.getElementById("appSelect");
        if (dropdown) dropdown.value = app;

        loadPrompt(app);
    }

    function selectAppFromDropdown() {
        const app = document.getElementById("appSelect").value;
        if (!app) return;
        selectApp(app);
    }

    function loadPrompt(app) {
        fetch("/llm/get/" + app)
            .then(res => res.json())
            .then(data => {
                document.getElementById("defaultPrompt").value = data.default_prompt || "";
                document.getElementById("customPrompt").value = data.custom_prompt || "";
                document.getElementById("enableToggle").checked = data.ai_active;
                document.getElementById("modelSelect").value = data.model_name || "gpt-4o-mini";
                updateToggleUI(document.getElementById("enableToggle"));
                updatePricingPanel();
            });
    }

    function updatePrompt() {
        if (!selectedApp) { alert("Select an application first"); return; }

        const data = {
            app_name: selectedApp,
            custom_prompt: document.getElementById("customPrompt").value,
            model_name: document.getElementById("modelSelect").value,
            ai_active: document.getElementById("enableToggle").checked,
            temperature: parseFloat(document.getElementById("tempSlider").value)
        };

        fetch("/llm/save/" + selectedApp, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        })
            .then(res => res.json())
            .then(data => {
                if (data.status === "saved") {
                    alert("AI Persona for " + selectedApp + " updated successfully!");
                } else {
                    alert("Error: " + (data.error || "Failed to save"));
                }
            });
    }

    function updateToggleUI(el) {
        const label = document.getElementById("statusLabel");
        if (el.checked) {
            label.innerText = "ACTIVE";
            label.style.color = "#22c55e";
        } else {
            label.innerText = "INACTIVE";
            label.style.color = "#94a3b8";
        }
    }

    function runTest() {
        const input = document.querySelector('input[placeholder="Simulate a user message..."]');
        const output = document.querySelector('p[style*="italic"]');

        if (!input.value) { alert("Please enter a test message"); return; }

        output.innerText = "Simulating response...";
        output.style.opacity = "0.5";

        // This is a placeholder for real AI test endpoint if exists
        setTimeout(() => {
            output.innerText = "Simulation successful. The agent will respond using the " + document.getElementById("modelSelect").value + " model with your custom persona overlay.";
            output.style.opacity = "1";
        }, 1500);
    }

    function resetPrompt() {
        if (confirm("Discard custom persona changes?")) {
            document.getElementById("customPrompt").value = document.getElementById("defaultPrompt").value;
        }
    }

    function createApp() {
        const name = prompt("Application identifier:");
        if (!name) return;

        fetch("/client/create_application", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ app_name: name })
        })
            .then(res => res.json())
            .then(data => {
                if (data.status === "created") {
                    location.reload();
                } else {
                    alert(data.error || "Creation failed");
                }
            });
    }

    window.onload = function () {
        if (selectedApp) {
            loadPrompt(selectedApp);
            const dropdown = document.getElementById("appSelect");
            if (dropdown) dropdown.value = selectedApp;
        }
    }

    const slider = document.getElementById("tempSlider");
    const valDisp = document.getElementById("tempValue");
    if (slider && valDisp) {
        slider.oninput = function () {
            valDisp.innerText = this.value;
        }
    }

    function updatePricingPanel() {
        const model = document.getElementById("modelSelect").value;
        const panel = document.getElementById("pricingPanel");
        if (!model) { panel.style.display = "none"; return; }

        fetch(`/api/model-pricing/${model}`)
            .then(res => res.json())
            .then(data => {
                if (data && data.model_name) {
                    panel.style.display = "block";
                    document.getElementById("inputCost").innerText = `$${(data.input_cost_per_1k_tokens || data.input_cost_per_1k).toFixed(5)}`;
                    document.getElementById("outputCost").innerText = `$${(data.output_cost_per_1k_tokens || data.output_cost_per_1k).toFixed(5)}`;

                    const avg = data.estimated_cost_per_call || 0.02;
                    document.getElementById("avgCost").innerText = `$${avg.toFixed(3)} / call`;

                    const monthly = avg * 3000;
                    document.getElementById("monthlyEst").innerText = `$${monthly.toFixed(2)}`;

                    const level = document.getElementById("modelLevel");
                    level.innerText = data.level || "Standard";
                    level.className = `badge-model ${data.level === 'Premium' ? 'badge-premium' : 'badge-budget'}`;

                    // Match theme colors
                    level.style.background = data.level === 'Premium' ? 'rgba(239, 68, 68, 0.15)' : 'rgba(34, 197, 94, 0.15)';
                    level.style.color = data.level === 'Premium' ? '#ef4444' : '#22c55e';
                    level.style.border = `1px solid ${data.level === 'Premium' ? 'rgba(239, 68, 68, 0.2)' : 'rgba(34, 197, 94, 0.2)'}`;
                } else {
                    panel.style.display = "none";
                }
            })
            .catch(() => { panel.style.display = "none"; });
    }

    // Call on change and initial load
    document.getElementById("modelSelect").addEventListener("change", updatePricingPanel);
    setTimeout(updatePricingPanel, 500);
</script>

{% endblock %}