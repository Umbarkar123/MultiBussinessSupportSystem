{% extends "layout.html" %}
{% block content %}

<div class="header">
    <h1>Booking Management</h1>
    <p style="color: var(--text-dim); font-size: 13px;">Review and manage booking requests from your applications in
        real-time.</p>
</div>

<!-- OPS KPI GRID -->
<div class="ops-kpi-grid">
    <div class="ops-kpi-card kpi-total">
        <div class="label">Total Requests <i class="fa fa-layer-group"></i></div>
        <div class="value" id="stat-total">{{total}}</div>
    </div>
    <div class="ops-kpi-card kpi-approved">
        <div class="label">Approved <i class="fa fa-check-circle"></i></div>
        <div class="value" id="stat-approved">{{approved}}</div>
    </div>
    <div class="ops-kpi-card kpi-pending">
        <div class="label">Pending <i class="fa fa-clock"></i></div>
        <div class="value" id="stat-pending">{{pending}}</div>
    </div>
    <div class="ops-kpi-card kpi-rejected">
        <div class="label">Rejected <i class="fa fa-times-circle"></i></div>
        <div class="value" id="stat-rejected">{{rejected}}</div>
    </div>
</div>

<!-- FILTER TABS -->
<div class="filter-tabs-row">
    <div class="filter-tab active" onclick="filterByStatus('ALL', this)">All Requests</div>
    <div class="filter-tab" onclick="filterByStatus('APPROVED', this)">Approved</div>
    <div class="filter-tab" onclick="filterByStatus('PENDING', this)">Pending</div>
    <div class="filter-tab" onclick="filterByStatus('REJECTED', this)">Rejected</div>
</div>

<!-- TABLE TOOLBAR -->
<div class="table-toolbar">
    <div class="toolbar-search">
        <i class="fa fa-search"></i>
        <input type="text" id="bookingSearch" placeholder="Search by name or phone..." onkeyup="searchBookings()">
    </div>

    <select class="toolbar-select" id="appFilter" onchange="filterByApp(this.value)">
        <option value="">All Applications</option>
        {% for a in apps %}
        <option value="{{a}}">{{a}}</option>
        {% endfor %}
    </select>

    <select class="toolbar-select">
        <option>All Time</option>
        <option>Today</option>
        <option>Last 7 Days</option>
        <option>Last 30 Days</option>
    </select>

    <button class="btn-primary" onclick="exportCSV()" style="height: 36px; padding: 0 16px; font-size: 12px;">
        <i class="fa fa-download"></i> Export CSV
    </button>
</div>

<!-- TABLE CARD -->
<div class="card" style="padding: 0; overflow: hidden;">
    <div class="table-responsive">
        <table class="table saas-table" id="bookingTable">
            <thead>
                <tr>
                    <th>User Detail</th>
                    <th>Application</th>
                    <th>Call</th>
                    <th>Requested Time</th>
                    <th>Scheduled Call Time</th>
                    <th>Status</th>
                    <th style="text-align:right">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% if not data %}
                <tr>
                    <td colspan="6" style="padding: 60px 20px; text-align: center;">
                        <i class="fa fa-inbox"
                            style="font-size: 40px; color: var(--text-dim); margin-bottom: 12px; display: block;"></i>
                        <span style="color: var(--text-dim); font-weight: 600;">No booking requests yet</span>
                    </td>
                </tr>
                {% endif %}

                {% for row in data %}
                <tr data-id="{{row._id}}" data-app="{{row.app_name}}" data-status="{{row.status}}"
                    onclick="toggleDetails('{{row._id}}')" style="cursor: pointer;">
                    <td>
                        <div style="display: flex; flex-direction: column;">
                            <span style="color: var(--text-bright); font-weight: 600;">{{row.name}}</span>
                            <span style="color: var(--text-dim); font-size: 11px;">{{row.phone}}</span>
                        </div>
                    </td>
                    <td><span
                            style="background: rgba(255,255,255,0.05); padding: 2px 8px; border-radius: 4px; font-size: 11px;">{{row.app_name}}</span>
                    </td>
                    <td>
                        {% if row.call_status %}
                        <span
                            style="color: {% if row.call_status == 'completed' %}var(--success){% elif row.call_status == 'failed' or row.call_status == 'busy' or row.call_status == 'no-answer' %}var(--danger){% else %}var(--primary){% endif %}; font-weight: 700; font-size: 11px; text-transform: capitalize;">
                            <i
                                class="fa {% if row.call_status == 'completed' %}fa-check-double{% elif row.call_status == 'ringing' %}fa-bell{% else %}fa-phone-volume{% endif %}"></i>
                            {{ row.call_status | replace('-', ' ') | title }}
                        </span>
                        {% elif row.call_initiated or row.call_initiated_at %}
                        <span style="color: var(--success); font-weight: 700; font-size: 11px;"><i
                                class="fa fa-check-circle"></i> Form Call</span>
                        {% else %}
                        <span style="color: var(--text-dim); font-size: 11px;"><i class="fa fa-minus-circle"></i>
                            Waiting</span>
                        {% endif %}
                    </td>
                    <td style="font-family: 'JetBrains Mono', monospace; font-size: 12px; color: #a5d6ff;">{{row.time}}
                    </td>
                    <td style="font-family: 'JetBrains Mono', monospace; font-size: 12px; color: var(--primary);">
                        {% if row.call_time %}
                        {{ row.call_time.strftime('%Y-%m-%d %I:%M %p') }}
                        {% else %}
                        <span style="color: var(--text-dim); font-style: italic;">No Schedule</span>
                        {% endif %}
                    </td>
                    <td>
                        <span class="status-pill {{row.status}}">
                            <span class="status-dot"></span>
                            {{row.status}}
                        </span>
                    </td>
                    <td style="text-align:right" onclick="event.stopPropagation();">
                        <div style="display: flex; justify-content: flex-end; gap: 8px;">
                            {% if row.status == "PENDING" %}
                            <a href="/approve/{{row._id|string}}" class="action-icon approve" title="Approve Request">
                                <i class="fa fa-check"></i>
                            </a>
                            <a href="/reject/{{row._id|string}}" class="action-icon reject" title="Reject Request">
                                <i class="fa fa-times"></i>
                            </a>
                            {% else %}
                            <span
                                style="color: var(--text-dim); font-size: 10px; font-weight: 700; text-transform: uppercase;">Processed</span>
                            {% endif %}
                        </div>
                    </td>
                </tr>

                <!-- Expandable Details Row -->
                <tr id="details-{{row._id}}" style="display: none;">
                    <td colspan="7" style="padding: 0; background: rgba(0, 0, 0, 0.2);">
                        <div
                            style="padding: 20px; border-top: 1px solid var(--border-color); border-bottom: 2px solid var(--border-color);">
                            <h4
                                style="margin: 0 0 16px 0; font-size: 12px; color: var(--primary); text-transform: uppercase; letter-spacing: 0.1em; display: flex; align-items: center; gap: 8px;">
                                <i class="fa fa-clipboard-list"></i> Detailed Form Submission Data
                            </h4>
                            <div
                                style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 10px;">
                                {% if row.data %}
                                {% for key, value in row.data.items() %}
                                <div
                                    style="background: var(--bg-input); padding: 10px 14px; border-radius: var(--radius-sm); border: 1px solid var(--border-color);">
                                    <span
                                        style="display: block; font-size: 10px; color: var(--text-dim); text-transform: uppercase; font-weight: 700; margin-bottom: 4px;">{{key}}</span>
                                    <span
                                        style="display: block; font-size: 13px; color: var(--text-bright); font-weight: 500;">{{value}}</span>
                                </div>
                                {% endfor %}
                                {% else %}
                                <p style="color: var(--text-dim); font-size: 13px; font-style: italic;">No additional
                                    form metadata captured.</p>
                                {% endif %}
                            </div>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    function toggleDetails(id) {
        const detailsRow = document.getElementById('details-' + id);
        detailsRow.style.display = detailsRow.style.display === 'none' ? 'table-row' : 'none';
    }

    function exportCSV() {
        let csv = [];
        let rows = document.querySelectorAll("table tr:not([id^='details'])");
        rows.forEach(row => {
            let cols = row.querySelectorAll("td, th");
            let data = Array.from(cols).map(c => {
                let text = c.innerText.replace(/\n/g, ' ').trim();
                return '"' + text + '"';
            }).join(",");
            csv.push(data);
        });
        let blob = new Blob([csv.join("\n")], { type: "text/csv" });
        let a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "connexhub_bookings_" + new Date().toISOString().slice(0, 10) + ".csv";
        a.click();
    }

    function filterByApp(app) {
        document.querySelectorAll("tbody tr:not([id^='details'])").forEach(row => {
            let rowApp = row.getAttribute("data-app");
            let statusMatch = true;
            // Integrate with status filter if present
            const activeTab = document.querySelector('.filter-tab.active').innerText.toUpperCase();
            if (activeTab !== 'ALL REQUESTS') {
                const rowStatus = row.getAttribute('data-status');
                statusMatch = (activeTab.includes(rowStatus));
            }

            if ((app === "" || rowApp === app) && statusMatch) {
                row.style.display = "";
            } else {
                row.style.display = "none";
                const detailsRow = document.getElementById('details-' + row.getAttribute('data-id'));
                if (detailsRow) detailsRow.style.display = "none";
            }
        });
    }

    function filterByStatus(status, tab) {
        document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');

        const app = document.getElementById('appFilter').value;

        document.querySelectorAll("tbody tr:not([id^='details'])").forEach(row => {
            let rowStatus = row.getAttribute("data-status");
            let rowApp = row.getAttribute("data-app");

            let statusMatch = (status === 'ALL' || rowStatus === status);
            let appMatch = (app === "" || rowApp === app);

            if (statusMatch && appMatch) {
                row.style.display = "";
            } else {
                row.style.display = "none";
                const detailsRow = document.getElementById('details-' + row.getAttribute('data-id'));
                if (detailsRow) detailsRow.style.display = "none";
            }
        });
    }

    function searchBookings() {
        const input = document.getElementById('bookingSearch').value.toLowerCase();
        const app = document.getElementById('appFilter').value;
        const activeTab = document.querySelector('.filter-tab.active').innerText.toUpperCase();

        document.querySelectorAll("tbody tr:not([id^='details'])").forEach(row => {
            const text = row.innerText.toLowerCase();
            const rowApp = row.getAttribute("data-app");
            const rowStatus = row.getAttribute("data-status");

            let searchMatch = text.includes(input);
            let appMatch = (app === "" || rowApp === app);
            let statusMatch = (activeTab === 'ALL REQUESTS' || activeTab.includes(rowStatus));

            if (searchMatch && appMatch && statusMatch) {
                row.style.display = "";
            } else {
                row.style.display = "none";
            }
        });
    }
</script>

{% endblock %}