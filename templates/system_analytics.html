{% extends "layout.html" %}
{% block content %}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="dash-wrap" style="padding: 24px; background: #020617; min-height: 100vh;">

    <!-- 1. HEADER SECTION -->
    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 24px;">
        <div>
            <h1 style="font-size: 24px; font-weight: 700; color: #f8fafc; margin: 0;">System Analytics</h1>
            <p style="font-size: 14px; color: #94a3b8; margin: 6px 0 0 0;">Complete performance overview of the platform
            </p>
        </div>
        <div style="display: flex; gap: 12px; align-items: center;">
            <p style="font-size: 11px; color: #64748b; margin: 0; margin-right: 8px;">Last Updated: <span
                    id="lastUpdated">Just now</span></p>
            <select
                style="background: #0f172a; border: 1px solid #1e293b; color: #f8fafc; padding: 8px 16px; border-radius: 8px; font-size: 13px; cursor: pointer; height: 38px;">
                <option>Last 7 Days</option>
                <option>Last 30 Days</option>
                <option>All Time</option>
            </select>
            <button onclick="exportAnalytics()"
                style="background: #14b8a6; color: white; border: none; padding: 0 16px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; height: 38px; display: flex; align-items: center; gap: 8px;">
                <i class="fa fa-download"></i> Export
            </button>
        </div>
    </div>

    <!-- 2. KPI SUMMARY ROW (4 equal cards) -->
    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 20px;">
        <div class="kpi-card">
            <div class="kpi-icon" style="background: rgba(0, 229, 255, 0.1); color: #00e5ff;">
                <i class="fa fa-phone"></i>
            </div>
            <div>
                <div class="kpi-value">{{ total_calls }}</div>
                <div class="kpi-label">Total Calls</div>
            </div>
        </div>
        <div class="kpi-card">
            <div class="kpi-icon" style="background: rgba(245, 158, 11, 0.1); color: #f59e0b;">
                <i class="fa fa-clock"></i>
            </div>
            <div>
                <div class="kpi-value">{{ pending }}</div>
                <div class="kpi-label">Pending</div>
            </div>
        </div>
        <div class="kpi-card">
            <div class="kpi-icon" style="background: rgba(34, 197, 94, 0.1); color: #22c55e;">
                <i class="fa fa-check-circle"></i>
            </div>
            <div>
                <div class="kpi-value">{{ approved }}</div>
                <div class="kpi-label">Approved</div>
            </div>
        </div>
        <div class="kpi-card">
            <div class="kpi-icon" style="background: rgba(239, 68, 68, 0.1); color: #ef4444;">
                <i class="fa fa-times-circle"></i>
            </div>
            <div>
                <div class="kpi-value">{{ rejected }}</div>
                <div class="kpi-label">Rejected</div>
            </div>
        </div>
    </div>

    <!-- 3. MAIN ANALYTICS SECTION -->

    <!-- Row 1 (Full width): Calls Trend Graph -->
    <div class="card" style="margin-bottom: 20px;">
        <div class="card-header">
            <h3><i class="fa fa-chart-line" style="color: #00e5ff;"></i> Calls Trend</h3>
        </div>
        <div style="height: 250px; width: 100%;">
            <canvas id="trendChart" data-labels='{{ calls_per_day | map(attribute="_id") | list | tojson }}'
                data-values='{{ calls_per_day | map(attribute="count") | list | tojson }}'></canvas>
        </div>
    </div>

    <!-- Row 2 (2 column layout): 70% Left, 30% Right -->
    <div style="display: grid; grid-template-columns: 7fr 3fr; gap: 20px; margin-bottom: 20px;">
        <!-- LEFT: Calls by Status -->
        <div class="card">
            <div class="card-header">
                <h3><i class="fa fa-list" style="color: #a855f7;"></i> Calls by Status</h3>
            </div>
            <div class="table-wrap">
                <table class="saas-table">
                    <thead>
                        <tr>
                            <th>Status</th>
                            <th>Trend</th>
                            <th style="text-align: right;">Volume</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for s in status_data %}
                        <tr>
                            <td>
                                <span class="status-badge {{ s.status | upper }}">
                                    {{ s.status }}
                                </span>
                            </td>
                            <td>
                                <div
                                    style="width: 100%; max-width: 180px; height: 6px; background: rgba(255,255,255,0.05); border-radius: 3px; overflow: hidden;">
                                    {% if total_calls > 0 %}
                                    {% set pct = (s.count / total_calls * 100) | round %}
                                    <div
                                        style="width: {{ pct }}%; height: 100%; background: {% if s.status == 'Approved' %}#22c55e{% elif s.status == 'Pending' %}#f59e0b{% else %}#ef4444{% endif %};">
                                    </div>
                                    {% else %}
                                    <div style="width: 0%; height: 100%;"></div>
                                    {% endif %}
                                </div>
                            </td>
                            <td style="text-align: right; font-weight: 600;">{{ s.count }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- RIGHT: Status Distribution -->
        <div class="card">
            <div class="card-header">
                <h3><i class="fa fa-chart-pie" style="color: #f59e0b;"></i> Distribution</h3>
            </div>
            <div style="height: 180px; position: relative;">
                <canvas id="statusChart" data-approved="{{ approved }}" data-pending="{{ pending }}"
                    data-rejected="{{ rejected }}"></canvas>
            </div>
        </div>
    </div>

    <!-- 4. CLIENT PERFORMANCE SECTION (Full width) -->
    <div class="card" style="margin-bottom: 20px;">
        <div class="card-header">
            <h3><i class="fa fa-building" style="color: #00e5ff;"></i> Top Performing Clients</h3>
        </div>
        <div class="table-wrap">
            <table class="saas-table">
                <thead>
                    <tr>
                        <th>Client ID</th>
                        <th style="text-align: right;">Total Calls</th>
                        <th style="text-align: right;">Approved</th>
                        <th style="text-align: right;">Pending</th>
                        <th style="text-align: right;">Approval %</th>
                    </tr>
                </thead>
                <tbody>
                    {% for c in top_clients %}
                    <tr>
                        <td><code style="color: #00e5ff; font-weight: 600;">{{ c._id }}</code></td>
                        <td style="text-align: right;">{{ c.total }}</td>
                        <td style="text-align: right; color: #22c55e; font-weight: 600;">{{ c.approved }}</td>
                        <td style="text-align: right; color: #f59e0b;">{{ c.pending }}</td>
                        <td style="text-align: right;">
                            {% if c.total > 0 %}
                            {{ ((c.approved / c.total) * 100) | round(1) }}%
                            {% else %}0%{% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- 5. CALLS PER DAY SECTION (Full width) -->
    <div class="card" style="margin-bottom: 20px;">
        <div class="card-header">
            <h3><i class="fa fa-calendar-alt" style="color: #14b8a6;"></i> Calls Per Day</h3>
        </div>
        <div class="table-wrap">
            <table class="saas-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Activity Intensity</th>
                        <th style="text-align: right;">Daily Volume</th>
                    </tr>
                </thead>
                <tbody>
                    {% for d in calls_per_day %}
                    <tr>
                        <td style="color: #f8fafc; font-weight: 500;">{{ d._id }}</td>
                        <td>
                            <div
                                style="width: 100%; max-width: 400px; height: 8px; background: rgba(255,255,255,0.03); border-radius: 4px; overflow: hidden;">
                                {% if total_calls > 0 %}
                                <div
                                    style="width: {{ (d.count / total_calls * 100) | round }}%; height: 100%; background: linear-gradient(90deg, #14b8a6, #00e5ff);">
                                </div>
                                {% else %}
                                <div style="width: 0%; height: 100%;"></div>
                                {% endif %}
                            </div>
                        </td>
                        <td style="text-align: right; font-weight: 700; color: #f8fafc;">{{ d.count }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- 6. RECENT ACTIVITY SECTION (Full width) -->
    <div class="card">
        <div class="card-header">
            <h3><i class="fa fa-history" style="color: #ef4444;"></i> Recent Activity</h3>
        </div>
        <div class="table-wrap">
            <table class="saas-table">
                <thead>
                    <tr>
                        <th>Customer</th>
                        <th>Phone</th>
                        <th>Application</th>
                        <th>Scheduled Call Time</th>
                        <th>Status</th>
                        <th style="text-align: right;">Date & Time</th>
                    </tr>
                </thead>
                <tbody>
                    {% for r in recent %}
                    <tr>
                        <td style="color: #f8fafc; font-weight: 500;">{{ r.name }}</td>
                        <td>{{ r.phone }}</td>
                        <td>
                            <span style="color: #00e5ff; font-weight: 600; font-size: 13px;">
                                {{ r.app_name or r.service or '—' }}
                            </span>
                        </td>
                        <td style="color: #00e5ff; font-weight: 500; font-size: 13px;">
                            {% if r.call_time %}
                            {{ r.call_time.strftime('%b %d, %H:%M') }}
                            {% else %}
                            <span style="opacity: 0.4; font-size: 11px;">Immediate</span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="status-pill {{ r.status }}">
                                {{ r.status }}
                            </span>
                        </td>
                        <td style="text-align: right; color: #94a3b8; font-size: 12px;">{{ r.created_at.strftime('%b %d,
                            %Y • %H:%M') if r.created_at else '—' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<style>
    /* SAAS DESIGN SYSTEM ITERATION 2 */
    :root {
        --bg: #020617;
        --card: #0f172a;
        --border: #1e293b;
        --primary-text: #f8fafc;
        --secondary-text: #94a3b8;
    }

    .kpi-card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 20px;
        display: flex;
        align-items: center;
        gap: 20px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: default;
    }

    .kpi-card:hover {
        border-color: #00e5ff;
        transform: translateY(-4px);
        box-shadow: 0 10px 20px -10px rgba(0, 229, 255, 0.2);
    }

    .kpi-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        flex-shrink: 0;
    }

    .kpi-label {
        font-size: 12px;
        font-weight: 600;
        color: var(--secondary-text);
        text-transform: uppercase;
        letter-spacing: 0.8px;
        margin-top: 4px;
    }

    .kpi-value {
        font-size: 26px;
        font-weight: 800;
        color: var(--primary-text);
        line-height: 1;
    }

    .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
    }

    .card-header {
        margin-bottom: 20px;
    }

    .card-header h3 {
        font-size: 14px;
        font-weight: 700;
        color: var(--primary-text);
        margin: 0;
        display: flex;
        align-items: center;
        gap: 10px;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .saas-table {
        width: 100%;
        border-collapse: collapse;
    }

    .saas-table th {
        text-align: left;
        font-size: 11px;
        font-weight: 600;
        color: #64748b;
        padding: 12px 16px;
        border-bottom: 1px solid var(--border);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .saas-table td {
        padding: 14px 16px;
        font-size: 14px;
        color: var(--secondary-text);
        border-bottom: 1px solid rgba(255, 255, 255, 0.02);
    }

    .saas-table tbody tr:hover {
        background: rgba(255, 255, 255, 0.02);
    }

    .saas-table tbody tr:last-child td {
        border-bottom: none;
    }

    .status-badge {
        padding: 4px 10px;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
    }

    .status-badge.APPROVED {
        background: rgba(34, 197, 94, 0.1);
        color: #22c55e;
        border: 1px solid rgba(34, 197, 94, 0.2);
    }

    .status-badge.PENDING {
        background: rgba(245, 158, 11, 0.1);
        color: #f59e0b;
        border: 1px solid rgba(245, 158, 11, 0.2);
    }

    .status-badge.REJECTED {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
        border: 1px solid rgba(239, 68, 68, 0.2);
    }

    .status-pill {
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
    }

    .status-pill.APPROVED {
        background: #22c55e;
        color: #fff;
    }

    .status-pill.PENDING {
        background: #f59e0b;
        color: #fff;
    }

    .status-pill.REJECTED {
        background: #ef4444;
        color: #fff;
    }

    .table-wrap {
        overflow-x: auto;
    }

    @media (max-width: 1024px) {
        [style*="grid-template-columns: repeat(4, 1fr)"] {
            grid-template-columns: repeat(2, 1fr) !important;
        }

        [style*="grid-template-columns: 7fr 3fr"] {
            grid-template-columns: 1fr !important;
        }
    }

    @media (max-width: 600px) {
        [style*="grid-template-columns: repeat(2, 1fr)"] {
            grid-template-columns: 1fr !important;
        }

        .dash-wrap {
            padding: 16px !important;
        }
    }
</style>

<script>
    Chart.defaults.color = '#64748b';
    Chart.defaults.font.family = "'Inter', sans-serif";
    Chart.defaults.font.size = 12;

    // Trend Chart
    const trendCtx = document.getElementById('trendChart');
    if (trendCtx) {
        new Chart(trendCtx, {
            type: 'line',
            data: {
                labels: JSON.parse(trendCtx.dataset.labels || '[]'),
                datasets: [{
                    label: 'Volume',
                    data: JSON.parse(trendCtx.dataset.values || '[]'),
                    borderColor: '#00e5ff',
                    backgroundColor: (context) => {
                        const ctx = context.chart.ctx;
                        const gradient = ctx.createLinearGradient(0, 0, 0, 300);
                        gradient.addColorStop(0, 'rgba(0, 229, 255, 0.2)');
                        gradient.addColorStop(1, 'rgba(0, 229, 255, 0)');
                        return gradient;
                    },
                    fill: true,
                    tension: 0.4,
                    pointRadius: 5,
                    pointBackgroundColor: '#00e5ff',
                    pointBorderColor: '#0f172a',
                    pointBorderWidth: 2,
                    borderWidth: 3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: '#1e293b',
                        titleColor: '#f8fafc',
                        bodyColor: '#94a3b8',
                        borderColor: '#334155',
                        borderWidth: 1,
                        padding: 12,
                        displayColors: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { color: 'rgba(255,255,255,0.04)' },
                        ticks: { padding: 10 }
                    },
                    x: {
                        grid: { display: false },
                        ticks: { padding: 10 }
                    }
                }
            }
        });
    }

    // Status Chart
    const statusCtx = document.getElementById('statusChart');
    if (statusCtx) {
        new Chart(statusCtx, {
            type: 'doughnut',
            data: {
                labels: ['Approved', 'Pending', 'Rejected'],
                datasets: [{
                    data: [
                        parseInt(statusCtx.dataset.approved || 0),
                        parseInt(statusCtx.dataset.pending || 0),
                        parseInt(statusCtx.dataset.rejected || 0)
                    ],
                    backgroundColor: ['#22c55e', '#f59e0b', '#ef4444'],
                    borderWidth: 0,
                    hoverOffset: 15
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '70%',
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { boxWidth: 10, padding: 20, usePointStyle: true, font: { size: 11 } }
                    }
                }
            }
        });
    }

    function exportAnalytics() {
        // Simple CSV Export Logic
        let csv = "Section,Metric,Value\n";
        csv += `Summary,Total Calls,{{ total_calls }}\n`;
        csv += `Summary,Pending,{{ pending }}\n`;
        csv += `Summary,Approved,{{ approved }}\n`;
        csv += `Summary,Rejected,{{ rejected }}\n`;

        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `system_analytics_${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
    }

    // Last Updated Time
    function updateTime() {
        const now = new Date();
        const display = document.getElementById('lastUpdated');
        if (display) display.innerText = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    }
    updateTime();
</script>

{% endblock %}