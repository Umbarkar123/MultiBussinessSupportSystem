<!DOCTYPE html>
<html>

<head>
    <title>ConnexHub</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>

<body>

    <!-- SIDEBAR -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <span class="logo"><i class="fa fa-bolt"></i></span>
            <span class="brand">ConnexHub</span>
        </div>

        <div class="nav-links">
            {% if session.role == "ADMIN" %}
            <a href="/super-dashboard"><i class="fa fa-chart-line"></i><span>System Dashboard</span></a>
            <a href="/calls"><i class="fa fa-phone"></i><span>All Calls</span></a>
            <a href="/admin/calls"><i class="fa fa-users"></i><span>Calls per Client</span></a>
            <a href="/manage-clients"><i class="fa fa-user-cog"></i><span>Clients</span></a>
            <a href="/system-analytics"><i class="fa fa-chart-pie"></i><span>Analytics</span></a>
            <a href="/api-key"><i class="fa fa-key"></i><span>API Key</span></a>
            {% elif session.role == "CLIENT" %}
            <a href="/analytics"><i class="fa fa-chart-bar"></i><span>Dashboard</span></a>
            <a href="/calls"><i class="fa fa-phone"></i><span>Calls</span></a>
            <a href="/booking-data"><i class="fa fa-database"></i><span>Booking Details</span></a>
            <a href="/client/applications"><i class="fa fa-th-large"></i><span>Applications</span></a>
            <a href="/llm-settings"><i class="fa fa-robot"></i><span>LLM Settings</span></a>
            <a href="/billing"><i class="fa fa-credit-card"></i><span>Billing & Usage</span></a>
            <a href="/pricing"><i class="fa fa-tags"></i><span>Plans & Pricing</span></a>
            <a href="/integration"><i class="fa fa-plug"></i><span>API & Integration</span></a>
            {% elif session.get('role') == "USER" %}
            <a href="/request"><i class="fa fa-microphone"></i><span>Request Call</span></a>
            <a href="/calls"><i class="fa fa-phone"></i><span>Calls</span></a>
            {% endif %}
        </div>

        <!-- PROFILE STRIP -->
        <div class="profile-strip" onclick="toggleDiscordCard()">
            <div class="ps-avatar-initial">{{ profile.name[0] | upper }}</div>
            <div class="ps-text">
                <div class="ps-name">{{ profile.name }}</div>
                <div class="ps-email">{{ profile.email }}</div>
            </div>
            <i class="fa fa-chevron-up ps-chevron" id="psChevron"></i>
        </div>
    </div>

    <!-- SAAS PROFILE CARD -->
    <div id="discordCard" class="discord-card">
        <!-- Header with gradient -->
        <div class="dc-header">
            <div class="dc-avatar-initial">{{ profile.name[0] | upper }}</div>
            <div class="dc-online-dot"></div>
        </div>

        <div class="dc-content">
            <!-- Name & Role -->
            <div class="dc-name">{{ profile.name }}</div>
            <div class="dc-role-row">
                <span class="dc-role-badge">{{ session.role | title }}</span>
                <span class="dc-status"><i class="fa fa-circle" style="font-size: 7px; color: #22c55e;"></i>
                    Online</span>
            </div>

            <!-- User Info -->
            <div class="dc-info-block">
                <div class="dc-info-row">
                    <i class="fa fa-envelope"></i>
                    <span>{{ profile.email }}</span>
                </div>
                {% if profile.phone %}
                <div class="dc-info-row">
                    <i class="fa fa-phone"></i>
                    <span>{{ profile.phone }}</span>
                </div>
                {% endif %}
            </div>

            <!-- Action Menu -->
            <div class="dc-actions">
                <a href="/profile" class="dc-action-row" onclick="event.stopPropagation();">
                    <i class="fa fa-pen"></i>
                    <span>Edit Profile</span>
                    <i class="fa fa-chevron-right dc-action-arrow"></i>
                </a>
                <a href="/change-password" class="dc-action-row" onclick="event.stopPropagation();">
                    <i class="fa fa-lock"></i>
                    <span>Change Password</span>
                    <i class="fa fa-chevron-right dc-action-arrow"></i>
                </a>
                <!-- UPDATED: Business Info is now a page, not a toggle -->
                <a href="/business-info" class="dc-action-row" onclick="event.stopPropagation();">
                    <i class="fa fa-briefcase"></i>
                    <span>Business Info</span>
                    <i class="fa fa-chevron-right dc-action-arrow"></i>
                </a>
            </div>

            <!-- Logout -->
            <a href="/logout" class="dc-logout-btn" onclick="event.stopPropagation();">
                <i class="fa fa-sign-out-alt"></i>
                <span>Logout</span>
            </a>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <!-- TOP HEADER (SaaS Navbar) -->
    <div class="app-header">
        <!-- Left: Search -->
        <div class="hdr-search">
            <i class="fa fa-search hdr-search-icon"></i>
            <input type="text" class="hdr-search-input" placeholder="Search users, calls, forms..." id="globalSearch">
        </div>

        <!-- Right: Controls -->
        <div class="hdr-right">
            <!-- Date Display -->
            <div class="hdr-date" id="hdrDate"></div>

            <!-- Notification Bell -->
            <div class="hdr-icon-wrap" id="notifWrap">
                <button class="hdr-icon-btn" onclick="toggleNotif(event)">
                    <i class="fa fa-bell"></i>
                    <span class="hdr-badge" id="notifBadge">3</span>
                </button>
                <!-- Notification Dropdown -->
                <div class="hdr-dropdown notif-dropdown" id="notifDropdown">
                    <div class="hdr-dd-header">
                        <span>Notifications</span>
                        <span class="hdr-dd-clear" onclick="clearNotifs()">Clear all</span>
                    </div>
                    <div class="notif-list">
                        <div class="notif-item unread">
                            <div class="notif-dot"></div>
                            <div class="notif-body">
                                <div class="notif-title">New form submitted</div>
                                <div class="notif-time">2 minutes ago</div>
                            </div>
                        </div>
                        <div class="notif-item unread">
                            <div class="notif-dot"></div>
                            <div class="notif-body">
                                <div class="notif-title">Call request approved</div>
                                <div class="notif-time">15 minutes ago</div>
                            </div>
                        </div>
                        <div class="notif-item unread">
                            <div class="notif-dot"></div>
                            <div class="notif-body">
                                <div class="notif-title">New user registered</div>
                                <div class="notif-time">1 hour ago</div>
                            </div>
                        </div>
                        <div class="notif-item">
                            <div class="notif-dot read"></div>
                            <div class="notif-body">
                                <div class="notif-title">LLM settings updated</div>
                                <div class="notif-time">Yesterday</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- User Profile Dropdown -->
            <div class="hdr-icon-wrap" id="profileWrap">
                <button class="hdr-profile-btn" onclick="toggleProfileMenu(event)">
                    <div class="hdr-avatar">{{ profile.name[0] | upper }}</div>
                    <div class="hdr-online-dot"></div>
                    <span class="hdr-username">{{ profile.name.split(' ')[0] }}</span>
                    <i class="fa fa-chevron-down hdr-chevron"></i>
                </button>
                <!-- Profile Dropdown -->
                <div class="hdr-dropdown profile-dropdown" id="profileDropdown">
                    <div class="hdr-dd-user">
                        <div class="hdr-dd-avatar">{{ profile.name[0] | upper }}</div>
                        <div>
                            <div class="hdr-dd-name">{{ profile.name }}</div>
                            <div class="hdr-dd-email">{{ profile.email }}</div>
                        </div>
                    </div>
                    <div class="hdr-dd-divider"></div>
                    <a href="/profile" class="hdr-dd-item">
                        <i class="fa fa-user"></i> View Profile
                    </a>
                    <a href="/settings" class="hdr-dd-item">
                        <i class="fa fa-cog"></i> Settings
                    </a>
                    <div class="hdr-dd-divider"></div>
                    <a href="/logout" class="hdr-dd-item danger">
                        <i class="fa fa-sign-out-alt"></i> Logout
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- SIDEBAR TOGGLE (for mobile) -->
    <div class="sidebar-toggle" onclick="toggleSidebar()" style="display: none;">
        <i class="fa fa-chevron-right"></i>
    </div>

    <!-- MAIN AREA -->
    <div class="main">
        {% block content %}{% endblock %}
    </div>

    <script>
        // ---- SIDEBAR PROFILE CARD ----
        function toggleDiscordCard() {
            const c = document.getElementById("discordCard");
            c.style.display = c.style.display === "block" ? "none" : "block";
        }

        function toggleBiz() {
            const b = document.getElementById("bizBox");
            b.style.display = b.style.display === "block" ? "none" : "block";
        }

        function toggleSidebar() {
            document.getElementById("sidebar").classList.toggle("active");
        }

        function showToast(msg) {
            const toast = document.getElementById("toast");
            toast.innerText = msg;
            toast.classList.add("show");
            setTimeout(() => { toast.classList.remove("show"); }, 2500);
        }

        // ---- HEADER: DATE DISPLAY ----
        (function () {
            const el = document.getElementById("hdrDate");
            if (!el) return;
            const now = new Date();
            const opts = { weekday: 'short', month: 'short', day: 'numeric' };
            el.textContent = now.toLocaleDateString('en-US', opts);
        })();

        // ---- HEADER: NOTIFICATION DROPDOWN ----
        function toggleNotif(e) {
            e.stopPropagation();
            const dd = document.getElementById("notifDropdown");
            const pd = document.getElementById("profileDropdown");
            pd.classList.remove("open");
            dd.classList.toggle("open");
        }

        function clearNotifs() {
            document.querySelectorAll(".notif-item.unread").forEach(el => el.classList.remove("unread"));
            document.querySelectorAll(".notif-dot").forEach(el => el.classList.add("read"));
            const badge = document.getElementById("notifBadge");
            if (badge) badge.style.display = "none";
        }

        // ---- HEADER: PROFILE DROPDOWN ----
        function toggleProfileMenu(e) {
            e.stopPropagation();
            const dd = document.getElementById("profileDropdown");
            const nd = document.getElementById("notifDropdown");
            nd.classList.remove("open");
            dd.classList.toggle("open");
        }

        // ---- CLICK OUTSIDE TO CLOSE ----
        document.addEventListener("click", function (e) {
            const notifWrap = document.getElementById("notifWrap");
            const profileWrap = document.getElementById("profileWrap");
            const discordCard = document.getElementById("discordCard");

            if (notifWrap && !notifWrap.contains(e.target)) {
                document.getElementById("notifDropdown").classList.remove("open");
            }
            if (profileWrap && !profileWrap.contains(e.target)) {
                document.getElementById("profileDropdown").classList.remove("open");
            }
            if (discordCard && !discordCard.contains(e.target)) {
                const strip = document.querySelector(".profile-strip");
                if (strip && !strip.contains(e.target)) {
                    discordCard.style.display = "none";
                }
            }
        });
    </script>

</body>

</html>