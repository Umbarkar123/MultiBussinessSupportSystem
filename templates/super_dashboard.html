{% extends "layout.html" %}
{% block content %}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="dash-wrap" style="padding: 16px; background: #020617; min-height: 100vh;">

    <!-- 12-COLUMN GRID CONTAINER -->
    <div style="display: grid; grid-template-columns: repeat(12, 1fr); gap: 16px;">

        <!-- ROW 1: 6 SMALL STAT CARDS (90px) -->
        <div class="apd-kpi" style="grid-column: span 2; height: 90px;">
            <div class="apd-kpi-icon" style="background: rgba(0,229,255,0.1); color: var(--primary);">
                <i class="fa fa-building"></i>
            </div>
            <div>
                <div class="apd-kpi-label">Total Clients</div>
                <div class="apd-kpi-value">{{ total_clients }}</div>
            </div>
        </div>
        <div class="apd-kpi" style="grid-column: span 2; height: 90px;">
            <div class="apd-kpi-icon" style="background: rgba(34,197,94,0.1); color: var(--success);">
                <i class="fa fa-users"></i>
            </div>
            <div>
                <div class="apd-kpi-label">Total Users</div>
                <div class="apd-kpi-value">{{ total_users }}</div>
            </div>
        </div>
        <div class="apd-kpi" style="grid-column: span 2; height: 90px;">
            <div class="apd-kpi-icon" style="background: rgba(168,85,247,0.1); color: #a855f7;">
                <i class="fa fa-phone"></i>
            </div>
            <div>
                <div class="apd-kpi-label">Total Calls</div>
                <div class="apd-kpi-value">{{ total_calls }}</div>
            </div>
        </div>
        <div class="apd-kpi" style="grid-column: span 2; height: 90px;">
            <div class="apd-kpi-icon" style="background: rgba(245,158,11,0.1); color: #f59e0b;">
                <i class="fa fa-clock"></i>
            </div>
            <div>
                <div class="apd-kpi-label">Pending</div>
                <div class="apd-kpi-value">{{ pending_calls }}</div>
            </div>
        </div>
        <div class="apd-kpi" style="grid-column: span 2; height: 90px;">
            <div class="apd-kpi-icon" style="background: rgba(34,197,94,0.1); color: #22c55e;">
                <i class="fa fa-check-circle"></i>
            </div>
            <div>
                <div class="apd-kpi-label">Approved</div>
                <div class="apd-kpi-value">{{ approved_calls }}</div>
            </div>
        </div>
        <div class="apd-kpi" style="grid-column: span 2; height: 90px;">
            <div class="apd-kpi-icon" style="background: rgba(0,229,255,0.1); color: #00e5ff;">
                <i class="fa fa-broadcast-tower"></i>
            </div>
            <div>
                <div class="apd-kpi-label">Active</div>
                <div class="apd-kpi-value">{{ active_clients }}</div>
            </div>
        </div>

        <!-- ROW 2: TREND (8) | INSIGHTS (4) -->
        <div class="card" style="grid-column: span 8; display: flex; flex-direction: column;">
            <h3 class="apd-card-title">
                <i class="fa fa-chart-line" style="color: var(--primary);"></i>System Calls Trend
            </h3>
            <div style="height: 250px; flex: 1;">
                <canvas id="trendChart" data-labels='{{ trend_data|map(attribute="_id")|list|tojson }}'
                    data-values='{{ trend_data|map(attribute="count")|list|tojson }}'></canvas>
            </div>
        </div>
        <div class="card" style="grid-column: span 4; display: flex; flex-direction: column;">
            <h3 class="apd-card-title">
                <i class="fa fa-lightbulb" style="color: #f59e0b;"></i>System Insights
            </h3>
            <div class="apd-insight-list"
                style="margin-top: 8px; flex: 1; display: flex; flex-direction: column; justify-content: space-evenly;">
                <div class="apd-insight-row">
                    <span class="apd-insight-label">Top Client</span>
                    <span class="apd-insight-val success">{{ system_insights.top_client }}</span>
                </div>
                <div class="apd-insight-row">
                    <span class="apd-insight-label">Peak Activity</span>
                    <span class="apd-insight-val">{{ system_insights.peak_day }}</span>
                </div>
                <div class="apd-insight-row">
                    <span class="apd-insight-label">Avg Calls/Client</span>
                    <span class="apd-insight-val">{{ system_insights.avg_calls }}</span>
                </div>
                <div class="apd-insight-row">
                    <span class="apd-insight-label">Approval Rate</span>
                    <span class="apd-insight-val success">{{ system_insights.approval_rate }}%</span>
                </div>
            </div>
        </div>

        <!-- ROW 3: DONUT (6) | BAR (6) -->
        <div class="card" style="grid-column: span 6; height: 230px; display: flex; flex-direction: column;">
            <h3 class="apd-card-title">
                <i class="fa fa-chart-pie" style="color: #a855f7;"></i>Status Distribution
            </h3>
            <div style="flex: 1; min-height: 0;">
                <canvas id="distChart"
                    data-approved="{{ status_dist.approved if status_dist.approved is not none else 0 }}"
                    data-pending="{{ status_dist.pending if status_dist.pending is not none else 0 }}"
                    data-rejected="{{ status_dist.rejected if status_dist.rejected is not none else 0 }}"></canvas>
            </div>
        </div>
        <div class="card" style="grid-column: span 6; height: 230px; display: flex; flex-direction: column;">
            <h3 class="apd-card-title">
                <i class="fa fa-chart-bar" style="color: var(--success);"></i>Calls per Client
            </h3>
            <div style="flex: 1; min-height: 0;">
                <canvas id="clientChart" data-labels='{{ client_activity|map(attribute="name")|list|tojson }}'
                    data-values='{{ client_activity|map(attribute="count")|list|tojson }}'></canvas>
            </div>
        </div>

        <!-- ROW 4: TABLE (8) | ACTIVITY (4) -->
        <div class="card" style="grid-column: span 8; min-height: 320px; overflow: hidden;">
            <h3 class="apd-card-title">
                <i class="fa fa-building" style="color: var(--primary);"></i>Client Performance Overview
            </h3>
            <div class="table-responsive" style="margin-top: 12px;">
                <table class="saas-table zebra" style="width: 100%;">
                    <thead>
                        <tr>
                            <th>Company</th>
                            <th style="text-align: center;">Total</th>
                            <th style="text-align: center;">Pending</th>
                            <th style="text-align: center;">Approved</th>
                            <th>Last Activity</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for c in clients %}
                        <tr>
                            <td><strong style="color: var(--text-bright);">{{ c.company }}</strong></td>
                            <td style="text-align: center; font-weight: 600;">{{ c.total }}</td>
                            <td style="text-align: center;">
                                <span class="status-pill PENDING">{{ c.pending }}</span>
                            </td>
                            <td style="text-align: center;">
                                <span class="status-pill APPROVED">{{ c.approved }}</span>
                            </td>
                            <td><span style="font-size: 11px; color: var(--text-dim);">{{ c.last_activity.strftime('%b
                                    %d, %H:%M') if c.last_activity else 'â€”' }}</span></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <div class="card" style="grid-column: span 4; display: flex; flex-direction: column;">
            <h3 class="apd-card-title">
                <i class="fa fa-history" style="color: var(--primary);"></i>Recent Activity
            </h3>
            <div class="activity-feed" style="margin-top: 12px; overflow-y: auto; flex: 1;">
                {% for item in activity_log %}
                <div class="apd-activity-item"
                    style="padding-bottom: 12px; margin-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.03);">
                    <div style="display: flex; gap: 10px; align-items: flex-start;">
                        <div
                            style="width: 6px; height: 6px; border-radius: 50%; background: {% if item.type == 'CLIENT_ADDED' %}var(--success){% else %}var(--primary){% endif %}; margin-top: 5px; flex-shrink: 0;">
                        </div>
                        <div>
                            <div style="font-size: 12px; color: var(--text-bright); line-height: 1.3;">{{ item.title }}
                            </div>
                            <div style="font-size: 10px; color: var(--text-dim);">{{ item.time.strftime('%b %d, %H:%M')
                                if item.time else 'Recent' }}</div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

    </div>
</div>

<script>
    // Config Chart.js Defaults
    Chart.defaults.color = '#94a3b8';
    Chart.defaults.font.size = 10;
    Chart.defaults.font.family = "'Inter', sans-serif";

    // System Trend
    const trendCtx = document.getElementById('trendChart');
    if (trendCtx) {
        new Chart(trendCtx, {
            type: 'line',
            data: {
                labels: JSON.parse(trendCtx.dataset.labels || '[]'),
                datasets: [{
                    data: JSON.parse(trendCtx.dataset.values || '[]'),
                    borderColor: '#00e5ff',
                    backgroundColor: 'rgba(0, 229, 255, 0.05)',
                    fill: true,
                    tension: 0.4,
                    pointRadius: 3,
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { grid: { color: 'rgba(255,255,255,0.04)' } },
                    y: { grid: { color: 'rgba(255,255,255,0.04)' }, beginAtZero: true }
                }
            }
        });
    }

    // Distribution
    const distCtx = document.getElementById('distChart');
    if (distCtx) {
        new Chart(distCtx, {
            type: 'doughnut',
            data: {
                labels: ['Approved', 'Pending', 'Rejected'],
                datasets: [{
                    data: [
                        parseInt(distCtx.dataset.approved || 0),
                        parseInt(distCtx.dataset.pending || 0),
                        parseInt(distCtx.dataset.rejected || 0)
                    ],
                    backgroundColor: ['#22c55e', '#f59e0b', '#ef4444'],
                    borderWidth: 0,
                    cutout: '75%'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: { boxWidth: 10, padding: 15 }
                    }
                }
            }
        });
    }

    // Client Activity
    const clientCtx = document.getElementById('clientChart');
    if (clientCtx) {
        new Chart(clientCtx, {
            type: 'bar',
            data: {
                labels: JSON.parse(clientCtx.dataset.labels || '[]'),
                datasets: [{
                    data: JSON.parse(clientCtx.dataset.values || '[]'),
                    backgroundColor: 'rgba(20, 184, 166, 0.7)',
                    borderRadius: 4,
                    barThickness: 12
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                plugins: { legend: { display: false } },
                scales: {
                    x: { grid: { color: 'rgba(255,255,255,0.04)' }, beginAtZero: true },
                    y: { grid: { display: false } }
                }
            }
        });
    }
</script>

<style>
    /* GLOBAL OVERRIDES FOR SUPER ADMIN */
    .apd-kpi {
        background: #0f172a;
        border: 1px solid #1e293b;
        border-radius: 12px;
        padding: 16px;
        display: flex;
        align-items: center;
        gap: 14px;
        position: relative;
        overflow: hidden;
    }

    .apd-kpi-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        flex-shrink: 0;
    }

    .apd-kpi-label {
        font-size: 10px;
        font-weight: 600;
        color: var(--text-dim);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .apd-kpi-value {
        font-size: 20px;
        font-weight: 700;
        color: var(--text-bright);
        line-height: 1.2;
    }

    .card {
        background: #0f172a;
        border: 1px solid #1e293b;
        border-radius: 12px;
        padding: 16px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .apd-card-title {
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.8px;
        color: var(--text-bright);
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .apd-insight-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.03);
    }

    .apd-insight-label {
        color: var(--text-dim);
        font-size: 12px;
    }

    .apd-insight-val {
        color: var(--text-bright);
        font-size: 12px;
        font-weight: 600;
    }

    .apd-insight-val.success {
        color: var(--success);
    }

    .saas-table th {
        background: rgba(255, 255, 255, 0.02);
        color: var(--text-bright);
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
        padding: 10px 12px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .saas-table td {
        padding: 8px 12px;
        font-size: 13px;
        color: var(--text-dim);
    }

    .saas-table.zebra tbody tr:nth-child(even) {
        background: rgba(255, 255, 255, 0.01);
    }

    .saas-table tr:hover {
        background: rgba(255, 255, 255, 0.03);
    }

    .status-pill {
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 10px;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
    }

    .status-pill.PENDING {
        background: rgba(245, 158, 11, 0.1);
        color: #f59e0b;
        border: 1px solid rgba(245, 158, 11, 0.2);
    }

    .status-pill.APPROVED {
        background: rgba(34, 197, 94, 0.1);
        color: #22c55e;
        border: 1px solid rgba(34, 197, 94, 0.2);
    }

    /* Scrollbar Styling */
    .activity-feed::-webkit-scrollbar {
        width: 4px;
    }

    .activity-feed::-webkit-scrollbar-track {
        background: transparent;
    }

    .activity-feed::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
    }

    @media (max-width: 1024px) {
        .dash-wrap>div {
            grid-template-columns: repeat(6, 1fr) !important;
        }

        .card,
        .apd-kpi {
            grid-column: span 3 !important;
        }

        [style*="span 8"],
        [style*="span 4"] {
            grid-column: span 6 !important;
        }
    }

    @media (max-width: 768px) {

        .card,
        .apd-kpi {
            grid-column: span 6 !important;
        }
    }
</style>

{% endblock %}