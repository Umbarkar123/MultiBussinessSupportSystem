{% extends "layout.html" %}
{% block content %}

<div class="header" style="margin-bottom: 24px;">
    <h1>Applications</h1>
    <p style="color: var(--text-dim); font-size: 14px;">Manage and monitor your AI-integrated business applications.</p>
</div>

<!-- TOP SUMMARY STRIP -->
<div class="apps-summary-strip">
    <div class="summary-box highlight">
        <div class="label">Total Applications</div>
        <div class="value">{{ (default_apps|length) + (client_apps|length) }}</div>
    </div>
    <div class="summary-box">
        <div class="label">Active (Live)</div>
        <div class="value" style="color: var(--success);">{{ (default_apps|length) + (client_apps|length or 0) }}</div>
    </div>
    <div class="summary-box">
        <div class="label">Inactive</div>
        <div class="value">0</div>
    </div>
    <div class="summary-box">
        <div class="label">Total Submissions</div>
        {% set total_subs = 0 %}
        {% for app in client_apps %}{% set total_subs = total_subs + (app.submissions or 0) %}{% endfor %}
        <div class="value">{{ total_subs }}</div>
    </div>
</div>

<!-- TOPBAR -->
<div class="apps-topbar" style="display: flex; gap: 12px; margin-bottom: 24px; align-items: center;">
    <div style="flex: 1; position: relative;">
        <i class="fa fa-search"
            style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-dim); font-size: 12px;"></i>
        <input class="search" placeholder="Search applications..."
            style="width: 100%; padding-left: 36px; height: 38px; background: var(--bg-input); border: 1px solid var(--border-color); color: var(--text-bright); border-radius: var(--radius-sm);">
    </div>

    <select class="select"
        style="height: 38px; background: var(--bg-input); color: var(--text-bright); border: 1px solid var(--border-color); border-radius: var(--radius-sm); padding: 0 12px;">
        <option>Status: All</option>
        <option>Live</option>
        <option>Inactive</option>
    </select>

    <select class="select"
        style="height: 38px; background: var(--bg-input); color: var(--text-bright); border: 1px solid var(--border-color); border-radius: var(--radius-sm); padding: 0 12px;">
        <option>Sort: Recent Activity</option>
        <option>Name (A-Z)</option>
        <option>Submissions (High-Low)</option>
    </select>

    <button class="btn-primary" onclick="createApp()" style="height: 38px; padding: 0 20px;">
        <i class="fa fa-plus"></i> Create Application
    </button>
</div>

<!-- GRID -->
<div class="apps-grid">

    {% if not default_apps and not client_apps %}
    <!-- EMPTY STATE -->
    <div class="empty-state-card">
        <i class="fa fa-layer-group"></i>
        <h2>No applications created yet</h2>
        <p>Start by creating your first application to integrate AI booking agents into your business.</p>
        <button class="btn-primary" onclick="createApp()" style="margin-top: 10px;">
            <i class="fa fa-plus"></i> Create First Application
        </button>
    </div>
    {% endif %}



    <!-- ðŸ”¹ CLIENT APPS -->
    {% for app in client_apps %}
    <div class="app-card" onclick="window.location.href='/client/application/{{app.app_name}}/dashboard'">
        <div class="app-card-head">
            <h3><i class="fa fa-rocket"></i> {{ app.app_name }}</h3>
            <div class="status-badge live">
                <span class="app-status-dot"></span>
                LIVE
            </div>
        </div>

        <div class="app-meta-grid">
            <div class="app-meta-item">
                <label>Submissions</label>
                <span>{{ app.submissions or 0 }} total</span>
            </div>
            <div class="app-meta-item">
                <label>Last Activity</label>
                <span>Recently</span>
            </div>
            <div class="app-meta-item">
                <label>Created On</label>
                <span>{{ app.created_at.strftime("%d %b %Y") if app.created_at else "Recently" }}</span>
            </div>
            <div class="app-meta-item">
                <label>Integration</label>
                <span style="color: var(--primary);">Pending</span>
            </div>
        </div>

        <div class="app-card-actions">
            <a href="/client/application/{{app.app_name}}/dashboard" class="btn-primary"
                onclick="event.stopPropagation()">Dashboard</a>

            {% if app.slug and app._id %}
            <a href="/form/{{app._id}}/{{app.slug}}" class="btn-view" target="_blank"
                onclick="event.stopPropagation()">View Form</a>
            {% else %}
            <!-- DYNAMIC URL FIX: Use client_id + app_name -->
            <a href="/form/{{client.client_id}}/{{app.app_name}}" class="btn-view" target="_blank"
                onclick="event.stopPropagation()">View Form</a>
            {% endif %}

            <div class="dots-menu" onclick="event.stopPropagation()">
                <div class="dots-trigger">â‹®</div>
                <div class="dropdown-content">
                    <a href="/client/application/{{app.app_name}}"><i class="fa fa-edit"></i> Edit Form</a>
                    <a href="#"
                        onclick="copyFormLink('{{client.client_id}}', '{{app._id}}', '{{app.slug}}', '{{app.app_name}}')"><i
                            class="fa fa-copy"></i> Copy Link</a>
                    <a href="/client/application/{{app.app_name}}/preview" target="_blank"><i class="fa fa-eye"></i>
                        Preview Form</a>
                    <div class="divider"></div>
                    <a href="#"><i class="fa fa-chart-line"></i> Analytics</a>
                    <button><i class="fa fa-pause"></i> Disable</button>
                    <button class="delete" onclick="deleteApp('{{app.app_name}}')"><i class="fa fa-trash"></i> Delete
                        App</button>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}

</div>

<script>
    function createApp() {
        const name = prompt("Enter Application Name:");
        if (!name) return;

        fetch("/client/create_application", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ app_name: name })
        }).then(() => location.reload());
    }

    function copyFormLink(clientId, appId, slug, appName) {
        let link = "";
        if (clientId && appName) {
            link = `${window.location.origin}/form/${clientId}/${appName}`;
        } else if (appId && slug) {
            link = `${window.location.origin}/form/${appId}/${slug}`;
        } else {
            link = `${window.location.origin}/form/${appName}`;
        }

        navigator.clipboard.writeText(link).then(() => {
            alert("Public form link copied to clipboard!");
        });
    }

    function deleteApp(appName) {
        if (!confirm(`Are you sure you want to delete "${appName}"? This will also delete its form and submissions.`)) return;

        fetch(`/client/application/${appName}/delete`, {
            method: "DELETE"
        }).then(() => location.reload());
    }
</script>

{% endblock %}